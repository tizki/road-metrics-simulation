<!DOCTYPE html>
<html>
<head>
    <title>Traffic Control System</title>
    <style>
        .road-container {
            margin: 20px;
            padding: 15px;
            border: 1px solid #ccc;
            border-radius: 5px;
        }
        .button {
            margin: 5px;
            padding: 10px 20px;
            border: none;
            border-radius: 4px;
            cursor: pointer;
        }
        .rush-hour { background-color: #f44336; color: white; }
        .normal { background-color: #4CAF50; color: white; }
        .night { background-color: #2196F3; color: white; }
        .stats {
            margin-top: 10px;
            font-size: 14px;
            color: #666;
        }
        
        /* Road animation styles */
        .road-animation {
            height: 40px;
            background-color: #333;
            margin: 15px 0;
            position: relative;
            overflow: hidden;
            border-radius: 4px;
            width: 100%;
        }
        
        .car {
            position: absolute;
            width: 20px;
            height: 10px;
            background-color: #fff;
            border-radius: 3px;
            animation: moveCar linear infinite;
        }
        
        /* Different lanes */
        .car:nth-child(odd) { top: 5px; }
        .car:nth-child(even) { top: 25px; }
        
        @keyframes moveCar {
            0% { left: -30px; }
            100% { left: 100%; }
        }
        
        /* Animation speeds for different patterns */
        .night .car { 
            animation-duration: 20s;
        }
        .normal .car { 
            animation-duration: 10s;
        }
        .rush-hour-animation .car { 
            animation-duration: 5s;
        }
    </style>
</head>
<body>
    <h1>Traffic Control System</h1>

    <div class="road-container">
        <h2>Road 1</h2>
        <div class="road-animation" id="animation-road-1">
        </div>
        <button class="button rush-hour" onclick="setTrafficPattern('road-1', 'rush_hour')">Rush Hour</button>
        <button class="button normal" onclick="setTrafficPattern('road-1', 'normal')">Normal</button>
        <button class="button night" onclick="setTrafficPattern('road-1', 'night')">Night</button>
        <div class="stats" id="stats-road-1">Loading stats...</div>
    </div>

    <div class="road-container">
        <h2>Road 6</h2>
        <div class="road-animation" id="animation-road-6">
        </div>
        <button class="button rush-hour" onclick="setTrafficPattern('road-6', 'rush_hour')">Rush Hour</button>
        <button class="button normal" onclick="setTrafficPattern('road-6', 'normal')">Normal</button>
        <button class="button night" onclick="setTrafficPattern('road-6', 'night')">Night</button>
        <div class="stats" id="stats-road-6">Loading stats...</div>
    </div>

    <div class="road-container">
        <h2>Ayalon</h2>
        <div class="road-animation" id="animation-Ayalon">
        </div>
        <button class="button rush-hour" onclick="setTrafficPattern('Ayalon', 'rush_hour')">Rush Hour</button>
        <button class="button normal" onclick="setTrafficPattern('Ayalon', 'normal')">Normal</button>
        <button class="button night" onclick="setTrafficPattern('Ayalon', 'night')">Night</button>
        <div class="stats" id="stats-Ayalon">Loading stats...</div>
    </div>

    <div class="road-container">
        <h2>Road 90</h2>
        <div class="road-animation" id="animation-road-90">
        </div>
        <button class="button rush-hour" onclick="setTrafficPattern('road-90', 'rush_hour')">Rush Hour</button>
        <button class="button normal" onclick="setTrafficPattern('road-90', 'normal')">Normal</button>
        <button class="button night" onclick="setTrafficPattern('road-90', 'night')">Night</button>
        <div class="stats" id="stats-road-90">Loading stats...</div>
    </div>

    <div class="road-container">
        <h2>Road 431</h2>
        <div class="road-animation" id="animation-road-431">
        </div>
        <button class="button rush-hour" onclick="setTrafficPattern('road-431', 'rush_hour')">Rush Hour</button>
        <button class="button normal" onclick="setTrafficPattern('road-431', 'normal')">Normal</button>
        <button class="button night" onclick="setTrafficPattern('road-431', 'night')">Night</button>
        <div class="stats" id="stats-road-431">Loading stats...</div>
    </div>

    <script>
        function setTrafficPattern(road, pattern) {
            fetch(`/set_rate?road=${road}&rate=${pattern}`, {
                method: 'GET'
            })
            .then(response => {
                if (!response.ok) {
                    throw new Error('Network response was not ok');
                }
                return response.text();
            })
            .then(data => {
                console.log('Success:', data);
                updateStats();
                updateAnimation(road, pattern);
            })
            .catch((error) => {
                console.error('Error:', error);
                alert('Failed to update traffic pattern');
            });
        }

        function createCar(index, total) {
            const car = document.createElement('div');
            car.className = 'car';
            // Distribute cars evenly across the animation duration
            const delay = (index / total) * 100;
            car.style.animationDelay = `-${delay}%`;
            return car;
        }

        function updateAnimation(road, pattern, numCars) {
            const animationElement = document.getElementById(`animation-${road}`);
            
            // Update pattern (speed)
            animationElement.classList.remove('night', 'normal', 'rush-hour-animation');
            if (pattern === 'night') {
                animationElement.classList.add('night');
                numCars = 1; // Just 1 car at night
            } else if (pattern === 'normal') {
                animationElement.classList.add('normal');
                numCars = 10; // 10 cars in normal traffic
            } else if (pattern === 'rush_hour') {
                animationElement.classList.add('rush-hour-animation');
                numCars = 50; // 50 cars during rush hour
            }

            // Add or remove cars as needed
            const currentCars = animationElement.children.length;
            if (currentCars < numCars) {
                // Add cars
                for (let i = currentCars; i < numCars; i++) {
                    animationElement.appendChild(createCar(i, numCars));
                }
            } else if (currentCars > numCars) {
                // Remove excess cars
                while (animationElement.children.length > numCars) {
                    animationElement.removeChild(animationElement.lastChild);
                }
            }
        }

        function updateStats() {
            fetch('/metrics')
            .then(response => response.text())
            .then(data => {
                const roads = ['road-1', 'road-6', 'Ayalon', 'road-90', 'road-431'];
                
                roads.forEach(road => {
                    const carsMatch = data.match(new RegExp(`cars_on_road{road="${road}"} ([0-9.]+)`));
                    const patternMatch = data.match(new RegExp(`traffic_pattern{road="${road}"} ([0-9.]+)`));
                    
                    let statsHtml = '';
                    let pattern = 'normal';
                    let cars = 0;

                    if (carsMatch) {
                        cars = Math.round(parseFloat(carsMatch[1]));
                        statsHtml += `Current cars: ${cars}<br>`;
                    }
                    
                    if (patternMatch) {
                        const patternValue = parseFloat(patternMatch[1]);
                        let patternText = 'Normal';
                        if (patternValue === 1) {
                            patternText = 'Night';
                            pattern = 'night';
                        } else if (patternValue === 3) {
                            patternText = 'Rush Hour';
                            pattern = 'rush_hour';
                        }
                        statsHtml += `Current pattern: ${patternText}`;
                    }
                    
                    updateAnimation(road, pattern, cars);
                    
                    const statsElement = document.getElementById(`stats-${road}`);
                    if (statsElement) {
                        statsElement.innerHTML = statsHtml;
                    }
                });
            })
            .catch(error => console.error('Error fetching stats:', error));
        }

        // Update stats every 2 seconds
        setInterval(updateStats, 2000);
        // Initial update
        updateStats();
    </script>
</body>
</html> 